<ng-container [ngSwitch]="dropdownDirection">
  <!-- DropDown or DropUp Mode -->
  <ng-container *ngSwitchCase="'down'">
    <div class="btn-group dropdown">
      <ng-container *ngTemplateOutlet="dropdownButton"></ng-container>
    </div>
  </ng-container>
  <ng-container *ngSwitchCase="'up'">
    <div class="btn-group dropup">
      <ng-container *ngTemplateOutlet="dropdownButton"></ng-container>
    </div>
  </ng-container>

  <!-- Expanded List Mode -->
  <ng-container *ngSwitchCase="'expandedList'">
    <!-- Search/Tag/Refresh Row (adapted from starter-packs.template.html) -->
    <div *ngIf="!inputAppsToShow" class="row" style="margin-bottom: 10px; display:flex; align-items:center;">
      <div class="col-md-6">
        <div class="form-group" style="margin-bottom:0">
          <label for="appSearch" class="sr-only">Search Apps</label>
          <div class="input-group input-group-sm">
            <input type="text" id="appSearch" class="form-control" placeholder="Search ..." [ngModel]="searchTerm" (ngModelChange)="searchSubject.next($event)" />
            <span class="input-group-btn" *ngIf="searchTerm">
              <button class="btn btn-default" type="button" title="Clear Search" (click)="searchSubject.next(''); searchTerm=''">
                <i class="fa fa-times"></i>
              </button>
            </span>
          </div>
        </div>
      </div>
      <div class="col-md-5">
        <span *ngIf="allTags.length === 0 && !isLoading && !isRefreshing" class="text-muted small">No tags defined.</span>
        <span *ngFor="let tag of allTags" style="margin-right:5px">
          <button class="btn btn-xs" [class.btn-primary]="selectedTag === tag" [class.btn-default]="selectedTag !== tag" (click)="filterByTag(tag)" title="Filter by tag: {{ tag }}">{{ tag }}</button>
        </span>
        <button *ngIf="selectedTag" class="btn btn-xs btn-warning" style="margin-left:5px" (click)="clearTagFilter()" title="Clear tag filter"><i class="fa fa-times"></i> {{ selectedTag }}</button>
      </div>
      <div class="col-md-1 text-right">
        <button class="btn btn-default btn-sm" type="button" (click)="refreshData()" [disabled]="isLoading || isRefreshing" title="Refresh List">
          <i class="fa fa-refresh" [class.fa-spin]="isRefreshing"></i>
        </button>
      </div>
    </div>
    <div class="list-group">
      <div *ngFor="let app of visibleApps" class="panel" [ngClass]="{
  'panel-info': app.state === 'running',
  'panel-primary': app.state === 'starting' || app.state === 'stopping',
  'panel-danger': app.state === 'error',
  'panel-default': app.state === 'stopped' || app.state === 'unknown'
}" style="margin-bottom: 10px;">


        <div class="panel-heading">
          <h4 class="panel-title">
            <i *ngIf="app.icon" [class]="app.icon" [style.color]="app.state === 'running' ? '#31708f' : (app.state === 'starting' || app.state === 'stopping') ? 'white' : '#888'" style="margin-right: 6px"></i>
            <span [style.color]="app.state === 'running' ? '#31708f' : (app.state === 'starting' || app.state === 'stopping') ? 'white' : '#888'">{{ app.name }}</span>
            <strong [style.color]="app.state === 'running' ? '#31708f' : (app.state === 'starting' || app.state === 'stopping') ? 'white' : '#888'" style="margin-left: 6px;">
              <i *ngIf="app.state === 'starting' || app.state === 'stopping'" class="fa fa-spinner fa-spin" style="margin-right: 5px;"></i>
              {{ app.state === 'running' ? 'running' : app.state === 'starting' ? 'starting' : app.state === 'stopping' ? 'stopping' : 'stopped' }}
            </strong>
          </h4>
        </div>
        <div class="panel-body">
          <p class="text-muted">{{ app.description }}</p>
          
          <!-- Editable Command Input (only for Docker apps) -->
          <div *ngIf="app.type === 'docker'" class="form-group" style="margin-top: 10px; margin-bottom: 10px;">
            <label class="sr-only" [for]="'cmd-' + app.id">Command</label>
            <input
              type="text"
              class="form-control input-sm"
              style="font-family: monospace; font-size: 0.9em;"
              [id]="'cmd-' + app.id"
              [(ngModel)]="app.currentCommandValue"
              [disabled]="app.state === 'starting' || app.state === 'stopping'"
              placeholder="Command to execute (edit port if needed)"
              title="Edit the command (e.g., change port) before starting/stopping."
            />
          </div>
          <!-- Action Button with Spinner and Dynamic Text -->
          <button
            class="btn"
            [ngClass]="{
              'btn-primary': app.state === 'running' || app.state === 'starting' || app.state === 'stopping',
              'btn-default': app.state === 'stopped' || app.state === 'unknown' || app.state === 'error'
            }"
            [disabled]="app.state === 'starting' || app.state === 'stopping'"
            (click)="onToggleApp(app)"
          >
            <i *ngIf="app.state === 'starting' || app.state === 'stopping'" class="fa fa-spinner fa-spin"></i>
            <i *ngIf="app.state !== 'starting' && app.state !== 'stopping'" class="fa"
               [ngClass]="{'fa-play': app.state !== 'running', 'fa-stop': app.state === 'running'}"></i>
            {{ app.state === 'running' ? 'Stop' : 'Start' }}
          </button>
          <a *ngIf="app.url && app.type !== 'desktop'" 
             [href]="app.state === 'running' ? app.url : null" 
             target="_blank" 
             class="btn btn-default pull-right" 
             [class.disabled]="app.state !== 'running'" 
             style="margin-left: 10px;">
            <i class="fa fa-external-link"></i> Launch
          </a>
          <!-- Last Output with Copy Button -->
          <pre *ngIf="app.lastOutput" style="margin-top: 10px; max-height: 35px; min-height: 35px; overflow-y: auto; background: #f8f9fa; padding: 5px; position: relative;">
            {{ app.lastOutput }}
            <button class="btn btn-default btn-xs" style="position: absolute; top: 5px; right: 5px;" (click)="copyToClipboard(app.lastOutput)">
              <i class="fa fa-copy"></i>
            </button>
          </pre>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #dropdownButton>
    <button
      id="appsManagerDropdownToggle"
      type="button"
      class="btn btn-default dropdown-toggle"
      data-toggle="dropdown"
      aria-haspopup="true"
      aria-expanded="false"
    >
      <ng-container *ngIf="(visibleApps?.length || 0) > 0; else manageAppsLabel">
        <i
          *ngIf="visibleApps[0]?.icon"
          [class]="visibleApps[0]?.icon"
          [style.color]="visibleApps[0]?.state === 'running' ? 'green' : '#888'"
          style="margin-right: 6px"
        ></i>
        <span
          id="appsManagerAppName{{sanitizeAppName(visibleApps[0]?.name)}}"
          [style.color]="visibleApps[0]?.state === 'running' ? 'green' : '#888'">
          {{ visibleApps[0]?.name }}
          <strong *ngIf="visibleApps[0]?.type !== 'desktop' && visibleApps[0]?.state !== 'running'" id="appsManagerAppState{{sanitizeAppName(visibleApps[0]?.name)}}" style="margin-left: 6px;">stopped</strong>
          <strong *ngIf="visibleApps[0]?.type !== 'desktop' && visibleApps[0]?.state === 'running'" id="appsManagerAppState{{sanitizeAppName(visibleApps[0]?.name)}}" style="margin-left: 6px;">running</strong>
        </span>
      </ng-container>
      <ng-template #manageAppsLabel>
        Manage Apps
      </ng-template>
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu" role="menu">
      <li role="menuitem" *ngFor="let app of visibleApps" [id]="'appsManagerApp' + sanitizeAppName(app.id)">
        <a class="dropdown-item" href="javascript:void(0)">
          <!-- Stop icon to the left of app name when running (dropdown mode) -->
          <span *ngIf="app.state === 'running' && app.type !== 'desktop'"
                [id]="'appsManagerAppStopBtn' + sanitizeAppName(app.id)"
                style="margin-right: 10px; vertical-align: middle; cursor: pointer;"
                (click)="onToggleApp(app); $event.stopPropagation();"
                title="Stop">
            <i class="fa fa-stop" style="color: #888; font-size: 16px;"></i>
          </span>
          <i
            *ngIf="app.icon"
            [class]="app.icon"
            [style.color]="app.state === 'running' ? 'green' : '#888'"
            style="margin-right: 6px"
          ></i>
          <span [id]="'appsManagerAppName' + sanitizeAppName(app.id)" [style.color]="app.state === 'running' ? 'green' : '#888'">
            {{ app.name }}
            <strong *ngIf="app.type !== 'desktop' && app.state !== 'running'" [id]="'appsManagerAppState' + sanitizeAppName(app.id)" style="margin-left: 6px;">stopped</strong>
            <strong *ngIf="app.type !== 'desktop' && app.state === 'running'" [id]="'appsManagerAppState' + sanitizeAppName(app.id)"style="margin-left: 6px;">running</strong>
          </span>
          <!-- Launch label when running and has URL -->
          <span
            *ngIf="app.url && app.type !== 'desktop'"
            class="btn btn-link btn-xs"
            style="padding: 0 4px; margin-left: 12px; vertical-align: middle;"
            [title]="
              app.state === 'running'
                ? 'Launch ' + app.name
                : app.name + ' is stopped, please start it'
            "
          >
            <ng-container *ngIf="app.state === 'running'; else disabledLaunchDropdown">
              <a
                [href]="app.url"
                target="_blank"
                (click)="$event.stopPropagation()"
                style="color: inherit; text-decoration: none;"
              >
                <i class="fa fa-external-link"></i>
                Launch
              </a>
            </ng-container>
            <ng-template #disabledLaunchDropdown>
              <button
                disabled
                style="background: none; border: none; color: #bbb; cursor: not-allowed; opacity: 0.6; padding: 0;"
                (click)="$event.stopPropagation()"
              >
                <i class="fa fa-external-link"></i>
                Launch
              </button>
            </ng-template>
          </span>
          <!-- Start button when stopped -->
          <button
            *ngIf="app.type !== 'desktop' && app.state !== 'running'"
            class="btn btn-xs btn-link"
            style="padding: 0 4px; vertical-align: middle;"
            (click)="onToggleApp(app); $event.stopPropagation();"
            [title]="'Start ' + app.name"
            [id]="'appsManagerAppStartBtn' + sanitizeAppName(app.id)"
          >
            <i class="fa fa-play" style="color: green"></i>
          </button>
          <!-- Desktop launch button -->
          <button
            *ngIf="app.type === 'desktop'"
            class="btn btn-xs btn-link"
            style="padding: 0 4px; vertical-align: middle;"
            (click)="onToggleApp(app); $event.stopPropagation();"
            [title]="'Launch ' + app.name"
          >
            <i class="fa fa-play-circle" [style.color]="app.state === 'running' ? 'green' : '#888'"></i>
          </button>
        </a>
      </li>
    </ul>
  </ng-template>
</ng-container>