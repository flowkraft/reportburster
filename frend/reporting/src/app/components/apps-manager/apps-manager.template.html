<ng-container [ngSwitch]="dropdownDirection">
  <!-- DropDown or DropUp Mode -->
  <ng-container *ngSwitchCase="'down'">
    <div class="btn-group dropdown">
      <ng-container *ngTemplateOutlet="dropdownButton"></ng-container>
    </div>
  </ng-container>
  <ng-container *ngSwitchCase="'up'">
    <div class="btn-group dropup">
      <ng-container *ngTemplateOutlet="dropdownButton"></ng-container>
    </div>
  </ng-container>

  <!-- Expanded List Mode -->
  <ng-container *ngSwitchCase="'expandedList'">
    <!-- Hidden AI Manager (only rendered when askAiForHelpOutputTypeCode is provided) -->
    <dburst-ai-manager *ngIf="askAiForHelpOutputTypeCode" #aiManagerInstance hidden></dburst-ai-manager>
    
    <!-- Search/Tag/Refresh Row (adapted from starter-packs.template.html) -->
    <div *ngIf="!inputAppsToShow" class="row" style="margin-bottom: 10px; display:flex; align-items:center;">
      <div class="col-md-6">
        <div class="form-group" style="margin-bottom:0">
          <label for="appSearch" class="sr-only">Search Apps</label>
          <div class="input-group input-group-sm">
            <input type="text" id="appSearch" class="form-control" placeholder="Search ..." [ngModel]="searchTerm" (ngModelChange)="searchSubject.next($event)" />
            <span class="input-group-btn" *ngIf="searchTerm">
              <button class="btn btn-default" type="button" title="Clear Search" (click)="searchSubject.next(''); searchTerm=''">
                <i class="fa fa-times"></i>
              </button>
            </span>
          </div>
        </div>
      </div>
      <div class="col-md-5">
        <span *ngIf="allTags.length === 0 && !isLoading && !isRefreshing" class="text-muted small">No tags defined.</span>
        <span *ngFor="let tag of allTags" style="margin-right:5px">
          <button class="btn btn-xs" [class.btn-primary]="selectedTag === tag" [class.btn-default]="selectedTag !== tag" (click)="filterByTag(tag)" title="Filter by tag: {{ tag }}">{{ tag }}</button>
        </span>
        <button *ngIf="selectedTag" class="btn btn-xs btn-warning" style="margin-left:5px" (click)="clearTagFilter()" title="Clear tag filter"><i class="fa fa-times"></i> {{ selectedTag }}</button>
      </div>
      <div class="col-md-1 text-right">
        <button class="btn btn-default btn-sm" type="button" (click)="refreshData()" [disabled]="isLoading || isRefreshing" title="Refresh List">
          <i class="fa fa-refresh" [class.fa-spin]="isRefreshing"></i>
        </button>
      </div>
    </div>
    <div class="list-group">
      <!-- Scoped styles for app cards in expandedList mode -->
      <style>
        .app-card-expanded {
          border: 1px solid #ddd;
          border-radius: 6px;
          transition: all 0.2s ease-in-out;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
          position: relative;
          z-index: 1;
        }
        .app-card-expanded:hover,
        .app-card-expanded:focus-within {
          border-color: #bbb;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          transform: translateY(-2px);
          z-index: 200;
        }
        .app-card-expanded.panel-info {
          border-color: #bce8f1;
        }
        .app-card-expanded.panel-info:hover {
          border-color: #31708f;
        }
        .app-card-expanded.panel-primary {
          border-color: #337ab7;
        }
        .app-card-expanded.panel-danger {
          border-color: #ebccd1;
        }
        .app-card-expanded.panel-danger:hover {
          border-color: #a94442;
        }
        .app-card-expanded .btn-group.open {
          z-index: 300;
        }
        .app-card-expanded .btn-group.open .dropdown-menu {
          z-index: 10000;
        }
      </style>
      <div *ngFor="let app of visibleApps; trackBy: trackByAppId" class="panel app-card-expanded"
           [id]="'appPanel_' + sanitizeAppId(app.id)"
           [ngClass]="{
  'panel-info': isAppRunning(app),
  'panel-primary': isStartingOrStopping(app),
  'panel-danger': isAppError(app),
  'panel-default': isAppStopped(app)
}" style="margin-bottom: 10px; overflow: visible;">
        <script>
          // DEBUG: Output app state and url for troubleshooting Launch button
          try {
            console.log('[AppsManager] Render app:', {
              id: '{{app.id}}',
              name: '{{app.name}}',
              state: '{{app.state}}',
              url: '{{app.url}}',
              isAppRunning: '{{isAppRunning(app)}}',
              showStop: '{{isAppRunning(app) || isStartingOrStopping(app)}}',
              showLaunch: '{{isAppRunning(app) && app.url}}'
            });
          } catch (e) {}
        </script>


        <div class="panel-heading" style="position: relative;">
          <h4 class="panel-title">
            <!-- Stop icon in heading (consistent with dropdown mode) -->
            <span *ngIf="isAppRunning(app) && app.type !== 'desktop'"
                  style="margin-right: 10px; vertical-align: middle; cursor: pointer;"
                  (click)="onToggleApp(app); $event.stopPropagation();"
                  title="Stop">
              <i class="fa fa-stop" style="color: #888; font-size: 16px;"></i>
            </span>

            <i *ngIf="app.icon" [class]="app.icon" [style.color]="(app.state === 'starting' || app.state === 'stopping') ? 'white' : '#333'" style="margin-right: 6px"></i>
            <span [id]="'appName_' + sanitizeAppId(app.id)" [style.color]="(app.state === 'starting' || app.state === 'stopping') ? 'white' : '#333'">{{ app.name }}</span>
            <strong [id]="'appState_' + sanitizeAppId(app.id)" [style.color]="app.state === 'running' ? '#31708f' : (app.state === 'starting' || app.state === 'stopping') ? 'white' : '#888'" style="margin-left: 6px;">
              <i *ngIf="isStartingOrStopping(app)" class="fa fa-spinner fa-spin" style="margin-right: 5px;"></i>
              {{ isAppRunning(app) ? 'running' : isAppStarting(app) ? 'starting' : isAppStopping(app) ? 'stopping' : 'stopped' }}
            </strong>
          </h4>
          <!-- App Source Badge -->
          <span *ngIf="app.tags?.includes('ReportBurster\'s App')" 
                class="label" 
                style="position: absolute; top: 8px; right: 10px; background-color: #5a9bb8; color: white; font-size: 11px; font-weight: 500; padding: 3px 8px; border-radius: 3px;"
                title="Built and maintained by ReportBurster">
            <i class="fa fa-check-circle" style="margin-right: 4px;"></i>Our App
          </span>
          <span *ngIf="!app.tags?.includes('ReportBurster\'s App')" 
                class="label" 
                style="position: absolute; top: 8px; right: 10px; background-color: #777; color: white; font-size: 11px; font-weight: 500; padding: 3px 8px; border-radius: 3px;"
                title="Third-party application">
            <ng-container *ngIf="app.website; else noWebsite">
              <a [href]="app.website" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">
                <i class="fa fa-external-link" style="margin-right: 4px;"></i>3rd Party
              </a>
            </ng-container>
            <ng-template #noWebsite>
              <i class="fa fa-external-link" style="margin-right: 4px;"></i>3rd Party
            </ng-template>
          </span>
        </div>
        <div class="panel-body">
          <div *ngIf="!app.tags?.includes('ReportBurster\'s App') && app.website" style="margin-bottom: 8px;">
            <a [href]="app.website" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: #31708f; font-weight: 500;">
              <i class="fa fa-external-link" style="margin-right: 6px;"></i>{{ app.website }}
            </a>
          </div>
          <p class="text-muted" [innerHTML]="app.description"></p>
          
          <!-- Editable Command Input (only for Docker apps, hidden when showDevButtons=false) -->
          <div *ngIf="app.type === 'docker' && showDevButtons" class="form-group" style="margin-top: 10px; margin-bottom: 10px;">
            <label class="sr-only" [for]="'cmd-' + app.id">Command</label>
            <input
              type="text"
              class="form-control input-sm"
              style="font-family: monospace; font-size: 0.9em;"
              [id]="'cmd-' + app.id"
              [(ngModel)]="app.currentCommandValue"
              [disabled]="isStartingOrStopping(app)"
              placeholder="Command to execute (edit port if needed)"
              title="Edit the command (e.g., change port) before starting/stopping."
            />
          </div>

          <!-- Build Options: show for Docker apps when stopped (Start is enabled) -->
          <div *ngIf="showDevButtons && app.type === 'docker' && !isAppRunning(app)" 
               style="margin-top: 5px; margin-bottom: 10px;">
            <label *ngIf="isFlowkraftApp(app)" class="checkbox-inline" style="font-size: 0.85em; cursor: pointer;"
                   title="Rebuild image using cache. Use when source code changed (*.groovy, *.java, *.gsp, views, assets)">
              <input type="checkbox" 
                     [checked]="app.currentCommandValue?.includes('--build')"
                     (change)="toggleCommandFlag(app, '--build', $event)"
                     [disabled]="isStartingOrStopping(app) || isDockerRequiredButMissing(app) || app.currentCommandValue?.includes('--no-cache') || app.currentCommandValue?.includes('--full')" />
              <code>--build</code>
              <i class="fa fa-info-circle text-muted" style="margin-left: 3px;"></i>
            </label>
            <label *ngIf="isFlowkraftApp(app)" class="checkbox-inline" style="font-size: 0.85em; margin-left: 15px; cursor: pointer;"
                   title="Full rebuild without cache. Use when Dockerfile or dependencies changed (build.gradle, pom.xml) — slower">
              <input type="checkbox" 
                     [checked]="app.currentCommandValue?.includes('--no-cache')"
                     (change)="toggleCommandFlag(app, '--no-cache', $event)"
                     [disabled]="isStartingOrStopping(app) || isDockerRequiredButMissing(app)" />
              <code>--no-cache</code>
              <i class="fa fa-info-circle text-muted" style="margin-left: 3px;"></i>
            </label>
            <label *ngIf="isFlowkraftApp(app)" class="checkbox-inline" style="font-size: 0.85em; margin-left: 15px; cursor: pointer;"
                   title="Enable Liquibase Groovy DSL database migrations. Runs changesets from db/migration/changelog.groovy on startup.">
              <input type="checkbox" 
                     [checked]="app.currentCommandValue?.includes('--liquibase')"
                     (change)="toggleCommandFlag(app, '--liquibase', $event)"
                     [disabled]="isStartingOrStopping(app) || isDockerRequiredButMissing(app)" />
              <code>--liquibase</code>
              <i class="fa fa-info-circle text-muted" style="margin-left: 3px;"></i>
            </label>

            <!-- Reprovision as a switch (adds --reprovision to start command) -->
            <label *ngIf="isCmsWebPortal(app)" class="checkbox-inline" style="font-size: 0.85em; margin-left: 0; cursor: pointer;" title="Reprovision the site: runs provisioning and theme rebuild">
              <input type="checkbox"
                     [checked]="app.currentCommandValue?.includes('--reprovision')"
                     (change)="toggleCommandFlag(app, '--reprovision', $event)"
                     [disabled]="isStartingOrStopping(app) || isDockerRequiredButMissing(app)" />
              <code>--reprovision</code>
              <i class="fa fa-info-circle text-muted" style="margin-left: 3px;"></i>
            </label>

            <label *ngIf="app.tags?.includes('ReportBurster\'s App')" class="checkbox-inline" style="font-size: 0.85em; margin-left: 15px; cursor: pointer;"
                   title="Full rebuild without cache and remove local images first. Heaviest operation — slower.">
              <input type="checkbox"
                     [checked]="app.currentCommandValue?.includes('--full')"
                     (change)="toggleCommandFlag(app, '--full', $event)"
                     [disabled]="isStartingOrStopping(app) || isDockerRequiredButMissing(app)" />
              <code>--full</code>
              <i class="fa fa-info-circle text-muted" style="margin-left: 3px;"></i>
            </label>

          </div>
          
          <!-- Build Options: show for Docker apps when stopped (Start is enabled) -->
          <div *ngIf="showDevButtons && app.type === 'docker' && isAppRunning(app)" 
               style="margin-top: 5px; margin-bottom: 10px;">

            <label *ngIf="app.tags?.includes('ReportBurster\'s App')" class="checkbox-inline" style="font-size: 0.85em; margin-left: 15px; cursor: pointer;" title="Remove persistent volumes (permanently deletes data stored in volumes)">
              <input type="checkbox"
                     [checked]="app.stopCmd?.includes('--volumes')"
                     (change)="toggleVolumesFlag(app, $event)"
                     [disabled]="isStartingOrStopping(app) || isDockerRequiredButMissing(app)" />
              <code>--volumes</code>
              <span style="color: #666; font-size: .85em; margin-left: 8px;">(Requires typing <strong>DELETE</strong>)</span>
              <i class="fa fa-info-circle text-muted" style="margin-left: 3px;"></i>
            </label>
          </div>

          
          <!-- Action Button with Spinner and Dynamic Text -->
          <button
            [id]="'btnStartStop_' + sanitizeAppId(app.id)"
            class="btn"
            [ngClass]="{
              'btn-primary': isAppRunning(app) || isStartingOrStopping(app),
              'btn-default': isAppStopped(app)
            }"
            [disabled]="isStartingOrStopping(app)"
            (click)="onToggleApp(app)"
          >
            <i *ngIf="isStartingOrStopping(app)" [id]="'appSpinner_' + sanitizeAppId(app.id)" class="fa fa-spinner fa-spin"></i>
            <i *ngIf="!isStartingOrStopping(app)" [id]="'appIcon_' + sanitizeAppId(app.id)" class="fa"
               [ngClass]="{'fa-play': !isAppRunning(app), 'fa-stop': isAppRunning(app)}"></i>
            {{ isAppStarting(app) ? 'Starting' : isAppStopping(app) ? 'Stopping' : isAppRunning(app) ? 'Stop' : 'Start' }}
          </button>

            <!-- Duplicate general volumes checkbox removed (CMS-specific volumes block above retained) -->

          <!-- Ask AI Button (only when askAiForHelpOutputTypeCode is provided) -->
          <button
            *ngIf="askAiForHelpOutputTypeCode"
            [id]="'btnAskAi_' + sanitizeAppId(app.id)"
            type="button"
            class="btn btn-default"
            style="margin-left: 10px;"
            (click)="askAiForHelp()"
          >
            <i class="fa fa-magic"></i> {{ getAiButtonLabel() }}
          </button>
          
          <!-- Launch Dropdown (when app has multiple launchLinks) -->
          <div *ngIf="app.type !== 'desktop' && app.launchLinks?.length > 1" 
            class="btn-group pull-right" 
            style="margin-left: 10px; position: relative; z-index: 9999;">
            <button type="button" 
                    class="btn btn-default dropdown-toggle" 
                    data-toggle="dropdown"
                    [disabled]="!isAppRunning(app)"
                    [class.disabled]="!isAppRunning(app)"
                    [title]="isAppRunning(app) ? 'Launch ' + app.name : app.name + ' is stopped'">
              <i class="fa fa-external-link"></i> Launch <span class="caret"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-right" style="z-index: 10000;">
              <li *ngFor="let link of app.launchLinks">
                <a [href]="isAppRunning(app) ? link.url : null" 
                   target="_blank"
                   [class.disabled]="!isAppRunning(app)"
                   [style.pointerEvents]="!isAppRunning(app) ? 'none' : 'auto'"
                   [style.color]="!isAppRunning(app) ? '#999' : 'inherit'">
                  <i *ngIf="link.icon" [class]="link.icon" style="margin-right: 6px; width: 14px; text-align: center;"></i>
                  <span [innerHTML]="link.label"></span>
                </a>
              </li>
            </ul>
          </div>

          <!-- Simple Launch Button (when app has single URL or no launchLinks) -->
          <a *ngIf="app.type !== 'desktop' && (!app.launchLinks || app.launchLinks.length <= 1)"
             [id]="'btnLaunch_' + sanitizeAppId(app.id)"
             [href]="isAppRunning(app) && app.url ? app.url : null"
             target="_blank"
             class="btn btn-default pull-right"
             [class.disabled]="!isAppRunning(app) || !app.url"
             [attr.tabindex]="!isAppRunning(app) || !app.url ? -1 : 0"
             [attr.aria-disabled]="!isAppRunning(app) || !app.url"
             [style.pointerEvents]="!isAppRunning(app) || !app.url ? 'none' : 'auto'"
             [title]="isAppRunning(app) && app.url ? ('Launch ' + app.name) : (isAppRunning(app) ? (app.name + ' has no URL') : (app.name + ' is stopped'))"
             style="margin-left: 10px;">
            <i class="fa fa-external-link"></i> Launch
          </a>
          
          <!-- Last Output with Copy Button -->
          <pre *ngIf="app.lastOutput" style="margin-top: 10px; max-height: 35px; min-height: 35px; overflow-y: auto; background: #f8f9fa; padding: 5px; position: relative;">
            {{ app.lastOutput }}
            <button class="btn btn-default btn-xs" style="position: absolute; top: 5px; right: 5px;" (click)="copyToClipboard(app.lastOutput)">
              <i class="fa fa-copy"></i>
            </button>
          </pre>
          <!-- Demo Login Info (shown only when app has demoInfo) -->
          <div *ngIf="app.demoInfo && isCmsWebPortal(app)" 
               [ngStyle]="{
                 'margin-top': '18px',
                 'padding': '14px 16px',
                 'background': isAppRunning(app) ? '#f0f7fa' : '#fafbfc',
                 'border': isAppRunning(app) ? '1px solid #d0e4ed' : '1px solid #e8e8e8',
                 'border-radius': '6px',
                 'font-size': '0.88em',
                 'color': isAppRunning(app) ? '#333' : '#555'
               }">
            <div [ngStyle]="{
                   'margin-bottom': '12px',
                   'padding-bottom': '8px',
                   'border-bottom': isAppRunning(app) ? '1px solid #d0e4ed' : '1px solid #eee',
                   'color': isAppRunning(app) ? '#555' : '#666'
                 }">
              <i class="fa fa-key" [ngStyle]="{'color': isAppRunning(app) ? '#5a9bb8' : '#888', 'margin-right': '6px'}"></i>Try the demo logins
            </div>
            <div style="line-height: 1.85;">
              <div style="margin-bottom: 8px;">
                <span style="color: #666;">Admin:</span>
                <span [ngStyle]="{
                        'font-weight': '600',
                        'color': isAppRunning(app) ? '#2c5282' : '#555',
                        'margin-left': '8px',
                        'background': isAppRunning(app) ? '#fff' : '#f0f0f0',
                        'padding': '2px 8px',
                        'border-radius': '3px',
                        'border': isAppRunning(app) ? '1px solid #d0e4ed' : 'none',
                        'cursor': 'pointer',
                        'user-select': 'all'
                      }"
                      title="Copy username"
                      (click)="copyCredential('u2changeme', $event)">u2changeme</span>
                <button class="btn btn-default btn-xs" 
                        style="margin-left: 4px; padding: 0 4px; font-size: 10px; vertical-align: middle;"
                        title="Copy username"
                        (click)="copyCredential('u2changeme', $event)">
                  <i class="fa fa-copy"></i>
                </button>
                <span style="color: #bbb; margin: 0 6px;">/</span>
                <span [ngStyle]="{
                        'font-weight': '600',
                        'color': isAppRunning(app) ? '#2c5282' : '#555',
                        'background': isAppRunning(app) ? '#fff' : '#f0f0f0',
                        'padding': '2px 8px',
                        'border-radius': '3px',
                        'border': isAppRunning(app) ? '1px solid #d0e4ed' : 'none',
                        'cursor': 'pointer',
                        'user-select': 'all'
                      }"
                      title="Copy password"
                      (click)="copyCredential('p2changeme123!', $event)">p2changeme123!</span>
                <button class="btn btn-default btn-xs" 
                        style="margin-left: 4px; padding: 0 4px; font-size: 10px; vertical-align: middle;"
                        title="Copy password"
                        (click)="copyCredential('p2changeme123!', $event)">
                  <i class="fa fa-copy"></i>
                </button>
                <span style="margin-left: 14px;">
                  <a href="http://localhost:8080/wp-admin" target="_blank" [ngStyle]="{'color': isAppRunning(app) ? '#5a9bb8' : '#999'}">admin area</a>
                  <span style="color: #ddd; margin: 0 6px;">•</span>
                  <a href="http://localhost:8080/my-documents" target="_blank" [ngStyle]="{'color': isAppRunning(app) ? '#5a9bb8' : '#999'}">frontend</a>
                </span>
              </div>
              <div>
                <span style="color: #666;">Employee:</span>
                <span [ngStyle]="{
                        'font-weight': '600',
                        'color': isAppRunning(app) ? '#2c5282' : '#555',
                        'margin-left': '8px',
                        'background': isAppRunning(app) ? '#fff' : '#f0f0f0',
                        'padding': '2px 8px',
                        'border-radius': '3px',
                        'border': isAppRunning(app) ? '1px solid #d0e4ed' : 'none',
                        'cursor': 'pointer',
                        'user-select': 'all'
                      }"
                      title="Copy username"
                      (click)="copyCredential('clyde.grew', $event)">clyde.grew</span>
                <button class="btn btn-default btn-xs" 
                        style="margin-left: 4px; padding: 0 4px; font-size: 10px; vertical-align: middle;"
                        title="Copy username"
                        (click)="copyCredential('clyde.grew', $event)">
                  <i class="fa fa-copy"></i>
                </button>
                <span style="color: #bbb; margin: 0 6px;">/</span>
                <span [ngStyle]="{
                        'font-weight': '600',
                        'color': isAppRunning(app) ? '#2c5282' : '#555',
                        'background': isAppRunning(app) ? '#fff' : '#f0f0f0',
                        'padding': '2px 8px',
                        'border-radius': '3px',
                        'border': isAppRunning(app) ? '1px solid #d0e4ed' : 'none',
                        'cursor': 'pointer',
                        'user-select': 'all'
                      }"
                      title="Copy password"
                      (click)="copyCredential('demo1234', $event)">demo1234</span>
                <button class="btn btn-default btn-xs" 
                        style="margin-left: 4px; padding: 0 4px; font-size: 10px; vertical-align: middle;"
                        title="Copy password"
                        (click)="copyCredential('demo1234', $event)">
                  <i class="fa fa-copy"></i>
                </button>
                <span style="margin-left: 14px;">
                  <a href="http://localhost:8080/my-documents" target="_blank" [ngStyle]="{'color': isAppRunning(app) ? '#5a9bb8' : '#999'}">frontend</a>
                </span>
                <span style="color: #888; margin-left: 12px;">— sees only own docs</span>
              </div>
            </div>
            <div style="margin-top: 12px; font-size: 0.85em; color: #999; user-select: all;">
              Other employees: kyle.butford, alfreda.waldback (password: demo1234)
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #dropdownButton>
    <button
      id="appsManagerDropdownToggle"
      type="button"
      class="btn btn-default dropdown-toggle"
      data-toggle="dropdown"
      aria-haspopup="true"
      aria-expanded="false"
    >
      <ng-container *ngIf="(visibleApps?.length || 0) > 0; else manageAppsLabel">
        <i
          *ngIf="visibleApps[0]?.icon"
          [class]="visibleApps[0]?.icon"
          [style.color]="visibleApps[0]?.state === 'running' ? '#31708f' : '#888'"
          style="margin-right: 6px"
        ></i>
        <span
          id="appsManagerToggleAppName{{sanitizeAppId(visibleApps[0]?.id)}}"
          [style.color]="visibleApps[0]?.state === 'running' ? '#31708f' : (visibleApps[0]?.state === 'starting' || visibleApps[0]?.state === 'stopping') ? '#337ab7' : '#888'">
          {{ visibleApps[0]?.name }}
          <strong *ngIf="visibleApps[0]?.type !== 'desktop'" id="appsManagerToggleAppState{{sanitizeAppId(visibleApps[0]?.id)}}" style="margin-left: 6px;">
            <i *ngIf="visibleApps[0]?.state === 'starting' || visibleApps[0]?.state === 'stopping'" class="fa fa-spinner fa-spin" style="margin-right: 4px;"></i>
            {{ visibleApps[0]?.state === 'running' ? 'running' : (visibleApps[0]?.state === 'starting' ? 'starting' : (visibleApps[0]?.state === 'stopping' ? 'stopping' : 'stopped')) }}
          </strong>
        </span>
      </ng-container>
      <ng-template #manageAppsLabel>
        Manage Apps
      </ng-template>
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu" role="menu">
      <li role="menuitem" *ngFor="let app of visibleApps; trackBy: trackByAppId" [id]="'appsManagerApp' + sanitizeAppId(app.id)">
        <a class="dropdown-item" href="javascript:void(0)">
          <!-- Stop icon to the left of app name when running (dropdown mode) -->
          <span *ngIf="app.state === 'running' && app.type !== 'desktop'"
                [id]="'appsManagerAppStopBtn' + sanitizeAppId(app.id)"
                style="margin-right: 10px; vertical-align: middle; cursor: pointer;"
                (click)="onToggleApp(app); $event.stopPropagation();"
                title="Stop">
            <i class="fa fa-stop" style="color: #888; font-size: 16px;"></i>
          </span>
          <i
            *ngIf="app.icon"
            [class]="app.icon"
            [style.color]="isAppRunning(app) ? '#31708f' : '#888'"
            style="margin-right: 6px"
          ></i>
          <span [id]="'appsManagerAppName' + sanitizeAppId(app.id)" [style.color]="app.state === 'running' ? '#31708f' : (app.state === 'starting' || app.state === 'stopping') ? '#337ab7' : '#888'">
            {{ app.name }}
            <strong *ngIf="app.type !== 'desktop'" [id]="'appsManagerAppState' + sanitizeAppId(app.id)" style="margin-left: 6px;">
              <i *ngIf="app.state === 'starting' || app.state === 'stopping'" class="fa fa-spinner fa-spin" style="margin-right: 4px;"></i>
              {{ app.state === 'running' ? 'running' : (app.state === 'starting' ? 'starting' : (app.state === 'stopping' ? 'stopping' : 'stopped')) }}
            </strong>
          </span>
          <!-- Launch label when running and has URL -->
          <span
            *ngIf="app.url && app.type !== 'desktop'"
            class="btn btn-link btn-xs"
            style="padding: 0 4px; margin-left: 12px; vertical-align: middle;"
            [title]="
              app.state === 'running'
                ? 'Launch ' + app.name
                : app.name + ' is stopped, please start it'
            "
          >
            <ng-container *ngIf="app.state === 'running'; else disabledLaunchDropdown">
              <a
                [href]="app.url"
                target="_blank"
                (click)="$event.stopPropagation()"
                style="color: inherit; text-decoration: none;"
              >
                <i class="fa fa-external-link"></i>
                Launch
              </a>
            </ng-container>
            <ng-template #disabledLaunchDropdown>
              <button
                disabled
                style="background: none; border: none; color: #bbb; cursor: not-allowed; opacity: 0.6; padding: 0;"
                (click)="$event.stopPropagation()"
              >
                <i class="fa fa-external-link"></i>
                Launch
              </button>
            </ng-template>
          </span>
          <!-- Start button when stopped (hidden during starting/stopping) -->
          <button
            *ngIf="app.type !== 'desktop' && isAppStopped(app)"
            class="btn btn-xs btn-link"
            style="padding: 0 4px; vertical-align: middle;"
            (click)="onToggleApp(app); $event.stopPropagation();"
            [title]="'Start ' + app.name"
            [id]="'appsManagerAppStartBtn' + sanitizeAppId(app.id)"
          >
            <i class="fa fa-play" style="color: #555"></i>
          </button>
          <!-- Desktop launch button -->
          <button
            *ngIf="app.type === 'desktop'"
            class="btn btn-xs btn-link"
            style="padding: 0 4px; vertical-align: middle;"
            (click)="onToggleApp(app); $event.stopPropagation();"
            [title]="'Launch ' + app.name"
          >
            <i class="fa fa-play-circle" [style.color]="app.state === 'running' ? '#31708f' : '#888'"></i>
          </button>
        </a>
      </li>
    </ul>
  </ng-template>
</ng-container>