const fs = require("fs")
const { execSync } = require("child_process")

function setProvider(provider) {
  const template = fs.readFileSync("prisma/schema.template.prisma", "utf8")
  const schema = template.replace("{{DATABASE_PROVIDER}}", provider)
  fs.writeFileSync("prisma/schema.prisma", schema)
}

function getTimestamp() {
  return new Date().toISOString().replace(/[-:]/g, "").split(".")[0]
}

function createDevMigrations() {
  console.log("\nğŸ”µ Creating development (SQLite) migrations...")
  setProvider("sqlite")

  if (!fs.existsSync("prisma/_dev-migrations-sqlite/migration_lock.toml")) {
    console.log("âš¡ No existing SQLite migrations found, creating new ones...")

    console.log("ğŸ“ Cleaning migrations directory...")
    execSync("npx shx rm -rf prisma/migrations/*", { stdio: "inherit" })

    console.log("ğŸ“ Setting up SQLite environment...")
    execSync("npx shx mkdir -p prisma/.dev-sqlite", { stdio: "inherit" })
    process.env.DATABASE_URL = "file:./.dev-sqlite/dev.db"

    console.log("âš™ï¸ Running Prisma migrate dev...")
    execSync("npx prisma migrate dev --name init", { stdio: "inherit" })

    console.log("ğŸ“ Backing up SQLite migrations...")
    execSync("npx shx mkdir -p prisma/_dev-migrations-sqlite", {
      stdio: "inherit",
    })
    execSync(
      "npx shx cp -r prisma/migrations/* prisma/_dev-migrations-sqlite/",
      { stdio: "inherit" }
    )

    console.log("âœ… Development migrations created successfully!")
  } else {
    console.log("â© SQLite migrations already exist, skipping creation")
  }
}

function createProdMigrations() {
  console.log("\nğŸ”µ Creating production (MySQL) migrations...")
  setProvider("mysql")

  if (!fs.existsSync("prisma/_prod-migrations-mysql/migration_lock.toml")) {
    console.log("âš¡ No existing MySQL migrations found, creating new ones...")

    console.log("ğŸ“ Cleaning migrations directory...")
    execSync("npx shx rm -rf prisma/migrations/*", { stdio: "inherit" })

    console.log("ğŸ“ Creating MySQL migrations directory...")
    const timestamp = getTimestamp()
    const migrationDir = `prisma/_prod-migrations-mysql/${timestamp}_init`
    execSync(`npx shx mkdir -p ${migrationDir}`, { stdio: "inherit" })

    console.log("âš™ï¸ Generating MySQL migration script...")
    execSync(
      `npx prisma migrate diff --from-empty --to-schema-datamodel prisma/schema.prisma --script > ${migrationDir}/migration.sql`,
      { stdio: "inherit" }
    )

    console.log("ğŸ“ Creating migration lock file...")
    fs.writeFileSync(
      "prisma/_prod-migrations-mysql/migration_lock.toml",
      '# Please do not edit this file manually\n# It should be added in your version-control system (e.g., Git)\nprovider = "mysql"'
    )

    console.log("âœ… Production migrations created successfully!")
  } else {
    console.log("â© MySQL migrations already exist, skipping creation")
  }
}

function migrateDevDatabase() {
  console.log("\nğŸ”µ Migrating development (SQLite) database...")
  setProvider("sqlite")

  if (!fs.existsSync("prisma/migrations/migration_lock.toml")) {
    console.log("âš¡ No active migrations found, copying SQLite migrations...")

    console.log("ğŸ“ Creating migrations directory...")
    execSync("npx shx mkdir -p prisma/migrations", { stdio: "inherit" })

    console.log("ğŸ“ Cleaning migrations directory...")
    execSync("npx shx rm -rf prisma/migrations/*", { stdio: "inherit" })

    console.log("ğŸ“ Setting up SQLite environment...")
    execSync("npx shx mkdir -p prisma/.dev-sqlite", { stdio: "inherit" })
    process.env.DATABASE_URL = "file:./.dev-sqlite/dev.db"

    console.log("ğŸ“ Copying SQLite migrations...")
    execSync(
      "npx shx cp -r prisma/_dev-migrations-sqlite/* prisma/migrations/",
      { stdio: "inherit" }
    )
  } else {
    console.log("âœ… Active migrations found")
  }

  console.log("âš™ï¸ Running Prisma migrate deploy...")
  execSync("npx prisma migrate deploy", { stdio: "inherit" })

  console.log("âœ… Development database migration complete!")
}

function checkProdEnvironment() {
  if (!process.env.DATABASE_PROVIDER || !process.env.DATABASE_URL) {
    throw new Error(
      "Missing required environment variables: DATABASE_PROVIDER and DATABASE_URL must be set for production migrations"
    )
  }
  if (process.env.DATABASE_PROVIDER !== "mysql") {
    throw new Error(
      "DATABASE_PROVIDER must be 'mysql' for production migrations"
    )
  }
}

function migrateProdDatabase() {
  console.log("\nğŸ”µ Migrating production (MySQL) database...")

  checkProdEnvironment()
  setProvider("mysql")

  if (!fs.existsSync("prisma/migrations/migration_lock.toml")) {
    console.log("âš¡ No active migrations found, copying MySQL migrations...")

    console.log("ğŸ“ Creating migrations directory...")
    execSync("npx shx mkdir -p prisma/migrations", { stdio: "inherit" })

    console.log("ğŸ“ Cleaning migrations directory...")
    execSync("npx shx rm -rf prisma/migrations/*", { stdio: "inherit" })

    console.log("ğŸ“ Copying MySQL migrations...")
    execSync(
      "npx shx cp -r prisma/_prod-migrations-mysql/* prisma/migrations/",
      { stdio: "inherit" }
    )

    console.log("ğŸ“ Creating baseline migration...")
    execSync("npx prisma migrate resolve --applied 0_init", {
      stdio: "inherit",
    })
  } else {
    console.log("âœ… Active migrations found")
  }

  console.log("âš™ï¸ Running Prisma migrate deploy...")
  execSync("npx prisma migrate deploy", { stdio: "inherit" })

  console.log("âœ… Production database migration complete!")
}

module.exports = {
  createDevMigrations,
  createProdMigrations,
  migrateDevDatabase,
  migrateProdDatabase,
}
