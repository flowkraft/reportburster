# Start from a base image with Node.js
FROM node:20-slim

# Set the working directory
WORKDIR /workspace

# Install utilities + AI-agent tooling (idempotent, minimal image size)
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    curl \
    git \
    ripgrep \
    jq \
    xmlstarlet \
    file \
    sed \
    gawk \
    perl \
    findutils \
    grep \
    htop \
    zip \
    unzip \
    procps \
    ca-certificates \
    gnupg \
    dirmngr \
    xz-utils \
    build-essential \
    python3-venv \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Node tooling helper (Corepack already present in Node 20 base)
RUN corepack enable || true

# Minimal, pinned global installation (simple & reproducible)
# - Install Anthropic CLI + Router first (pinned) then the UI for predictable behavior
RUN npm install -g @anthropic-ai/claude-code@2.1.17 @musistudio/claude-code-router@1.0.73 @siteboon/claude-code-ui@1.13.6 && npm cache clean --force

# Lightweight helper: quick check for Anthropic CLI presence (does NOT install it)
RUN printf '%s
' "#!/usr/bin/env bash" "set -euo pipefail" "if command -v claude >/dev/null 2>&1; then" "  echo 'Found \''claude\'' CLI â€” run \''claude --help\'' and ensure your ANTHROPIC_API_KEY is set.'" "else" "  echo 'Anthropic Claude CLI not found in the container. Install it with: npm install -g @anthropic-ai/claude-code'" "fi" > /usr/local/bin/claude-config-check && chmod +x /usr/local/bin/claude-config-check

# Expose runtime port for Claude Code UI (default: 3001)
EXPOSE 3001

# Default command: start Claude Code UI (global install)
CMD ["claude-code-ui"]